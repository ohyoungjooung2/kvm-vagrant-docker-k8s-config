[root@kubeworker3 ~]# cat /etc/fstab

#
# /etc/fstab
# Created by anaconda on Sat May 12 18:50:26 2018
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/VolGroup00-LogVol00 /                       xfs     defaults        0 0
UUID=570897ca-e759-4c81-90cf-389da6eee4cc /boot                   xfs     defaults        0 0
#/dev/mapper/VolGroup00-LogVol01 swap                    swap    defaults        0 0
/dev/vdb                                  /plocal_disk2  ext4    defaults        0 0



#K8s node add
[vagrant@kubemaster ~]$ kubectl get nodes
NAME           STATUS   ROLES    AGE     VERSION
dockerlocalg   Ready    <none>   2d18h   v1.14.2
kubemaster     Ready    master   2d19h   v1.14.2
kubeworker1    Ready    <none>   2d18h   v1.14.2
kubeworker2    Ready    <none>   2d18h   v1.14.2



[vagrant@kubemaster ~]$ kubeadm token create
o7vbo1.71zcpwe5ppxjepd4
[vagrant@kubemaster ~]$ 


[vagrant@kubemaster ~]$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
a163dc8af45c321027c834d58e4bbd7c3bbf4aabc557b52d91b2a9356c9bcc91
[vagrant@kubemaster ~]$ 





[root@kubeworker3 ~]# kubeadm join --token o7vbo1.71zcpwe5ppxjepd4 10.1.0.2:6443 --discovery-token-ca-cert-hash sha256:a163dc8af45c321027c834d58e4bbd7c3bbf4aabc557b52d91b2a9356c9bcc91
[preflight] Running pre-flight checks
	[WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.14" ConfigMap in the kube-system namespace
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Activating the kubelet service
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.




[vagrant@kubemaster ~]$ kubectl get nodes
NAME           STATUS   ROLES    AGE     VERSION
dockerlocalg   Ready    <none>   2d19h   v1.14.2
kubemaster     Ready    master   2d19h   v1.14.2
kubeworker1    Ready    <none>   2d19h   v1.14.2
kubeworker2    Ready    <none>   2d19h   v1.14.2
kubeworker3    Ready    <none>   7m55s   v1.14.2
[vagrant@kubemaster ~]$ 





#storage class for wordpress

[vagrant@kubemaster ~]$ cat wp-local-pv-sc.yaml 
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: plocal-storage-wp
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
[vagrant@kubemaster ~]$ kubectl create -f wp-local-pv-sc.yaml 
storageclass.storage.k8s.io/plocal-storage-wp created
[vagrant@kubemaster ~]$ kb get sc
NAME                PROVISIONER                    AGE
plocal-storage      kubernetes.io/no-provisioner   2d15h
plocal-storage-wp   kubernetes.io/no-provisioner   6s




[vagrant@kubemaster ~]$ cat wp-local-pv.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: plocal-disk-wp
spec:
  capacity:
    storage: 10Gi
  # volumeMode field requires BlockVolume Alpha feature gate to be enabled.
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: plocal-storage-wp
  local:
    path: /plocal_disk2
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - kubeworker3
[vagrant@kubemaster ~]$ kb create -f wp-local-pv.yaml 
persistentvolume/plocal-disk-wp created
[vagrant@kubemaster ~]$ kb get pv
NAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                              STORAGECLASS        REASON   AGE
plocal-disk      10Gi       RWO            Delete           Bound       default/plocal-storage-mariadb-0   plocal-storage               2d1h
plocal-disk-wp   10Gi       RWO            Delete           Available                                      plocal-storage-wp            4s


#maria db root password.









[vagrant@kubemaster wptest]$ cat kustomization.yaml 
secretGenerator:
- name: mariadb-pass
  literals:
  - password=StrongPass$^^$
resources:
  - mariadb-nore.yaml
[vagrant@kubemaster wptest]$ cat mariadb-nore.yaml 
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mariadb
spec:
  selector:
    matchLabels:
      app: mariadb
  serviceName: mariadb
  replicas: 1
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
      - name: mariadb
        image: mariadb:10.1.14
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
               name: mariadb-pass
               key: password
        ports:
        - name: mariadb
          containerPort: 3306
        volumeMounts:
        - name: plocal-storage
          mountPath: /var/lib/mysql
          subPath: mariadb

        resources:
          requests:
            cpu: 500m
            memory: 1Gi

  volumeClaimTemplates:
  - metadata:
      #name: data
      name: plocal-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "plocal-storage"
      resources:
        requests:
          storage: 10Gi




[vagrant@kubemaster wptest]$ kb apply -k .
secret/mariadb-pass-hmt2hb8m6g created
statefulset.apps/mariadb created
[vagrant@kubemaster wptest]$ 



[vagrant@kubemaster ~]$ kb exec -it mariadb-0 bash
root@mariadb-0:/# ls
bin  boot  core  dev  docker-entrypoint-initdb.d  docker-entrypoint.sh	etc  home  lib	lib64  media  mnt  opt	proc  root  run  sbin  srv  sys  tmp  usr  var
root@mariadb-0:/# mysql
ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: NO)
root@mariadb-0:/# mysql -u root -p

MariaDB [(none)]> show databases
    -> ;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
3 rows in set (0.00 sec)


MariaDB [mysql]> select password from user;
+-------------------------------------------+
| password                                  |
+-------------------------------------------+
| *D674B2C0175FB3763DD6952371BE0DA43805D876 |
+-------------------------------------------+


[vagrant@kubemaster wptest]$ cat wp-svc.yaml 
apiVersion: v1
kind: Service
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  ports:
    - port: 80
  selector:
    app: wordpress
    tier: frontend
  type: NodePort
  ports:
  - port: 8070
    targetPort: 80
    protocol: TCP
    name: http
  

[vagrant@kubemaster wptest]$ kb create -f wp-svc.yaml 
service/wordpress created
[vagrant@kubemaster wptest]$ kb get svc
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
kubernetes   ClusterIP   10.96.0.1        <none>        443/TCP          3d3h
mariadb      ClusterIP   None             <none>        3306/TCP         2d9h
wordpress    NodePort    10.107.160.122   <none>        8070:32398/TCP   2s



[vagrant@kubemaster wptest]$ cat wp-pvc.yaml 
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wp-pv-claim
  labels:
    app: wordpress
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: plocal-storage-wp
[vagrant@kubemaster wptest]$ kb create -f wp-pvc.yaml 
persistentvolumeclaim/wp-pv-claim created
[vagrant@kubemaster wptest]$ kb get pvc
NAME                       STATUS    VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS        AGE
plocal-storage-mariadb-0   Bound     plocal-disk   10Gi       RWO            plocal-storage      45m
wp-pv-claim                Pending                            




[vagrant@kubemaster wp]$ cat kustomization.yaml 
secretGenerator:
- name: mariadb-pass
  literals:
  - password=StrongPass$^^$
resources:
  - wp-dep.yaml
[vagrant@kubemaster wp]$ cat wp-dep.yaml 
---
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  selector:
    matchLabels:
      app: wordpress
      tier: frontend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: frontend
    spec:
      containers:
      - image: wordpress:4.8-apache
        name: wordpress
        env:
        - name: WORDPRESS_DB_HOST
          value: mariadb
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-pass
              key: password
        ports:
        - containerPort: 80
          name: wordpress
        volumeMounts:
        - name: wordpress-persistent-storage
          mountPath: /var/www/html
      volumes:
      - name: wordpress-persistent-storage
        persistentVolumeClaim:
          claimName: wp-pv-claim


[vagrant@kubemaster wp]$ kb apply -k .
secret/mariadb-pass-hmt2hb8m6g unchanged
deployment.apps/wordpress created


[vagrant@kubemaster wp]$ kb get po
NAME                         READY   STATUS    RESTARTS   AGE
mariadb-0                    1/1     Running   0          49m
wordpress-585d79f44d-dkltk   1/1     Running   0          109s
[vagrant@kubemaster wp]$ 

[vagrant@kubemaster wp]$ kb get svc wordpress
NAME        TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
wordpress   NodePort   10.107.160.122   <none>        8070:32398/TCP   32m

[vagrant@kubemaster ~]$ kb get po
NAME                         READY   STATUS    RESTARTS   AGE
mariadb-0                    1/1     Running   0          108m
wordpress-56f5bf46dd-v58rm   1/1     Running   0          21m
[vagrant@kubemaster ~]$ kb describe po wordpress-56f5bf46dd-v58rm
Name:               wordpress-56f5bf46dd-v58rm
Namespace:          default
Priority:           0
PriorityClassName:  <none>
Node:               kubeworker3/192.168.121.139
Start Time:         Mon, 03 Jun 2019 20:07:41 +0000
Labels:             app=wordpress
                    pod-template-hash=56f5bf46dd
                    tier=frontend
Annotations:        <none>
Status:             Running
IP:                 10.244.4.7
Controlled By:      ReplicaSet/wordpress-56f5bf46dd
Containers:
  wordpress:
    Container ID:   docker://62e867bb24ba6c24515bec47bf22513e3c752d49b173717c5caba67ce582492e
    Image:          wordpress:4.8-apache
    Image ID:       docker-pullable://wordpress@sha256:6216f64ab88fc51d311e38c7f69ca3f9aaba621492b4f1fa93ddf63093768845
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Mon, 03 Jun 2019 20:07:42 +0000
    Ready:          True
    Restart Count:  0
    Environment:
      WORDPRESS_DB_HOST:      mariadb
      WORDPRESS_DB_PASSWORD:  <set to the key 'password' in secret 'mariadb-pass-hmt2hb8m6g'>  Optional: false
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-wxbxs (ro)
      /var/www/html from wordpress-persistent-storage (rw)
Conditions:
  Type              Status
  Initialized       True 
  Ready             True 
  ContainersReady   True 
  PodScheduled      True 
Volumes:
  wordpress-persistent-storage:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  wp-pv-claim
    ReadOnly:   false
  default-token-wxbxs:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-wxbxs
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type    Reason     Age   From                  Message
  ----    ------     ----  ----                  -------
  Normal  Scheduled  21m   default-scheduler     Successfully assigned default/wordpress-56f5bf46dd-v58rm to kubeworker3
  Normal  Pulled     21m   kubelet, kubeworker3  Container image "wordpress:4.8-apache" already present on machine
  Normal  Created    21m   kubelet, kubeworker3  Created container wordpress
  Normal  Started    21m   kubelet, kubeworker3  Started container wordpress
[vagrant@kubemaster ~]$ telnet 10.244.4.7 80
Trying 10.244.4.7...
Connected to 10.244.4.7.
Escape character is '^]'.
^]

telnet> q
Connection closed.

[vagrant@kubemaster ~]$ wget 10.244.4.7
--2019-06-03 20:30:12--  http://10.244.4.7/
Connecting to 10.244.4.7:80... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://10.244.4.7/wp-admin/install.php [following]
--2019-06-03 20:30:12--  http://10.244.4.7/wp-admin/install.php
Reusing existing connection to 10.244.4.7:80.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: 'index.html.1'

    [ <=>                                                                  ] 11,351      --.-K/s   in 0.04s   

2019-06-03 20:30:13 (310 KB/s) - 'index.html.1' saved [11351]


From host if nodePort is working or not.
oyj@Workstation-oyj-X555QG ~/kvm-vagrant-docker-k8s-config$wget http://10.1.0.5:32333
--2019-06-05 08:25:49--  http://10.1.0.5:32333/
Connecting to 10.1.0.5:32333... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://10.1.0.5:32333/wp-admin/install.php [following]
--2019-06-05 08:25:49--  http://10.1.0.5:32333/wp-admin/install.php
Reusing existing connection to 10.1.0.5:32333.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: ‘index.html’

index.html                   [ <=>                              ]  11.11K  --.-KB/s    in 0.03s   

2019-06-05 08:25:51 (428 KB/s) - ‘index.html’ saved [11375]

oyj@Workstation-oyj-X555QG ~/kvm-vagrant-docker-k8s-config$wget http://10.1.0.3:32333
--2019-06-05 08:25:59--  http://10.1.0.3:32333/
Connecting to 10.1.0.3:32333... connected.
HTTP request sent, awaiting response... 302 Found
Location: http://10.1.0.3:32333/wp-admin/install.php [following]
--2019-06-05 08:25:59--  http://10.1.0.3:32333/wp-admin/install.php
Reusing existing connection to 10.1.0.3:32333.
HTTP request sent, awaiting response... 200 OK
Length: unspecified [text/html]
Saving to: ‘index.html.1’

index.html.1                 [ <=>                              ]  11.11K  --.-KB/s    in 0.03s   

2019-06-05 08:26:00 (443 KB/s) - ‘index.html.1’ saved [11375]





#Add disk for mariadb slave. Volume is local disk in kubeworker2 node.
[root@kubeworker2 ~]# df -h | grep -i vdb
/dev/vdb                         9.8G   37M  9.2G   1% /mariadb-slave
[root@kubeworker2 ~]# 


[vagrant@kubemaster ~]$ cat slave-mariadb-pv-sc.yaml 
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: mariadb-slave-sc
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
[vagrant@kubemaster ~]$ kubectl create -f slave-mariadb-pv-sc.yaml 
storageclass.storage.k8s.io/mariadb-slave-sc created
[vagrant@kubemaster ~]$ kbe get sc
-bash: kbe: command not found
[vagrant@kubemaster ~]$ kb get sc | grep slave
mariadb-slave-sc    kubernetes.io/no-provisioner   9s


[vagrant@kubemaster ~]$ cat slave-mariadb-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: slave-mariadb-pv
spec:
  capacity:
    storage: 10Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: mariadb-slave-sc
  local:
    path: /mariadb-slave
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - kubeworker2




[vagrant@kubemaster ~]$ kb create -f slave-mariadb-pv.yaml 
persistentvolume/slave-mariadb-pv created



vagrant@kubemaster ~]$ kb get pv | grep slave
slave-mariadb-pv   10Gi       RWO            Delete           Available                                      mariadb-slave-sc             3m43s


[vagrant@kubemaster mariadb_sv]$ cat slave-mariadb-svc.yaml 
apiVersion: v1
kind: Service
metadata:
  name: mariadb-slave
  labels:
    app: mariadb-slave
spec:
  ports:
  - name: mariadb-slave
    port: 3306
  clusterIP: None
  selector:
    app: mariadb-slave


[vagrant@kubemaster mariadb_sv]$ kb get svc
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
kubernetes      ClusterIP   10.96.0.1       <none>        443/TCP          6d22h
mariadb         ClusterIP   None            <none>        3306/TCP         72m
mariadb-slave   ClusterIP   None            <none>        3306/TCP         3s
wordpress       NodePort    10.105.152.51   <none>        8070:32333/TCP   2d15h


[vagrant@kubemaster mariadb_sv]$ cat kustomization.yaml 
secretGenerator:
- name: mariadb-pass
  literals:
  - password=StrongPass$^^$
resources:
  - mariadb-slave.yaml






[vagrant@kubemaster mariadb_sv]$ cat mariadb-slave.yaml 
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mariadb-slave
spec:
  selector:
    matchLabels:
      app: mariadb-slave
  serviceName: mariadb-slave
  replicas: 1
  template:
    metadata:
      labels:
        app: mariadb-slave
    spec:
      containers:
      - name: mariadb
        image: mariadb:10.1.14
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
               name: mariadb-pass
               key: password
        ports:
        - name: mariadb-slave
          containerPort: 3306
        volumeMounts:
        - name: mariadb-slave
          mountPath: /var/lib/mysql
          subPath: mariadb-sv
        
        #volumeMounts:
        #- name: plocal-storage
        #  mountPath: /etc/mysql
        #  subPath: etc_mysql
 

        resources:
          requests:
            cpu: 500m
            memory: 1Gi

  volumeClaimTemplates:
  - metadata:
      #name: data
      name: mariadb-slave
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "mariadb-slave-sc"
      resources:
        requests:
          storage: 10Gi



[vagrant@kubemaster mariadb_sv]$ kb apply -k .
secret/mariadb-pass-hmt2hb8m6g unchanged
statefulset.apps/mariadb-slave created


#Mariadb 10.1.. myster server for replication.
[vagrant@kubemaster configmap_files]$ cat my-master.cnf 
# MariaDB-specific config file.
# Read by /etc/mysql/my.cnf
#
[client]
#  Default is Latin1, if you need UTF-8 set this (also in server section)
# default-character-set = utf8 
#
[mysqld]
#master server for replication
log-bin
server_id=1
log-basename=master1
# * Character sets
#  Default is Latin1, if you need UTF-8 set all this (also in client section)
character_set_server   = utf8 
collation_server       = utf8_general_ci 
#
[mysqld_safe]
skip_log_error
syslog

[mariadb]
# See https://mariadb.com/kb/en/how-to-enable-tokudb-in-mariadb/
# # for instructions how to enable TokuDB
# #
# # See https://mariadb.com/kb/en/tokudb-differences/ for differences
# # between TokuDB in MariaDB and TokuDB from http://www.tokutek.com/
#
# #plugin-load-add=ha_tokudb.so



[vagrant@kubemaster configmap_files]$ kb create configmap mariadb-master.cnf --from-file=my-master.cnf
configmap/mariadb-master.cnf created
[vagrant@kubemaster configmap_files]$ kb describe configmap mariadb-master.cnf
Name:         mariadb-master.cnf
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
my-master.cnf:
----
# MariaDB-specific config file.
# Read by /etc/mysql/my.cnf
#
[client]
#  Default is Latin1, if you need UTF-8 set this (also in server section)
# default-character-set = utf8 
#
[mysqld]
#master server for replication
log-bin
server_id=1
log-basename=master1
# * Character sets
#  Default is Latin1, if you need UTF-8 set all this (also in client section)
character_set_server   = utf8 
collation_server       = utf8_general_ci 
#
[mysqld_safe]
skip_log_error
syslog

[mariadb]
# See https://mariadb.com/kb/en/how-to-enable-tokudb-in-mariadb/
# # for instructions how to enable TokuDB
# #
# # See https://mariadb.com/kb/en/tokudb-differences/ for differences
# # between TokuDB in MariaDB and TokuDB from http://www.tokutek.com/
#
# #plugin-load-add=ha_tokudb.so

Events:  <none>




[vagrant@kubemaster mariadb]$ cat mariadb-nore.yaml 
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mariadb
spec:
  selector:
    matchLabels:
      app: mariadb
  serviceName: mariadb
  replicas: 1
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
      - name: mariadb
        image: mariadb:10.1.14
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
               name: mariadb-pass
               key: password
        ports:
        - name: mariadb
          containerPort: 3306
        volumeMounts:
        - name: plocal-storage
          mountPath: /var/lib/mysql
          subPath: mariadb
        - name: mariadb-master-cnf
          mountPath: /etc/mysql/conf.d
        
          

        resources:
          requests:
            cpu: 500m
            memory: 1Gi
      volumes:
      - name: mariadb-master-cnf
        configMap:
          name: mariadb-master.cnf
  volumeClaimTemplates:
  - metadata:
      #name: data
      name: plocal-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "plocal-storage"
      resources:
        requests:
          storage: 10Gi





[vagrant@kubemaster mariadb]$ kb get po
NAME                         READY   STATUS    RESTARTS   AGE
mariadb-0                    1/1     Running   0          46m
mariadb-slave-0              1/1     Running   1          24h
wordpress-77bd488d8b-2dtgb   1/1     Running   1          25h
[vagrant@kubemaster mariadb]$ ls
configmap_files  kustomization.yaml  mariadb-nore.yaml  mariadb-svc.yaml  mariadb_sv
[vagrant@kubemaster mariadb]$ kb apply -k .
secret/mariadb-pass-hmt2hb8m6g unchanged
statefulset.apps/mariadb configured
[vagrant@kubemaster mariadb]$ kb get po
NAME                         READY   STATUS    RESTARTS   AGE
mariadb-0                    1/1     Running   0          62s
mariadb-slave-0              1/1     Running   1          24h
wordpress-77bd488d8b-2dtgb   1/1     Running   1          25h


[vagrant@kubemaster mariadb]$ kb exec -it mariadb-0 bash
root@mariadb-0:/# ls
bin   core  docker-entrypoint-initdb.d	etc   lib    media  opt   root	sbin  sys  usr
boot  dev   docker-entrypoint.sh	home  lib64  mnt    proc  run	srv   tmp  var
root@mariadb-0:/# ls /etc/mysql/my.cnf 
/etc/mysql/my.cnf
root@mariadb-0:/# ls /etc/mysql/
conf.d/       debian-start  debian.cnf    my.cnf        
root@mariadb-0:/# ls /etc/mysql/conf.d/
my-master.cnf
root@mariadb-0:/# cat /etc/mysql/conf.d/my-master.cnf 
# MariaDB-specific config file.
# Read by /etc/mysql/my.cnf
#
[client]
#  Default is Latin1, if you need UTF-8 set this (also in server section)
# default-character-set = utf8 
#
[mysqld]
#master server for replication
log-bin
server_id=1
log-basename=master1
# * Character sets
#  Default is Latin1, if you need UTF-8 set all this (also in client section)
character_set_server   = utf8 
collation_server       = utf8_general_ci 
#
[mysqld_safe]
skip_log_error
syslog

[mariadb]
# See https://mariadb.com/kb/en/how-to-enable-tokudb-in-mariadb/
# # for instructions how to enable TokuDB
# #
# # See https://mariadb.com/kb/en/tokudb-differences/ for differences
# # between TokuDB in MariaDB and TokuDB from http://www.tokutek.com/
#
# #plugin-load-add=ha_tokudb.so


#master-slave replication usr



[vagrant@dockerlocalg ~]$ cat docker-entrypoint.sh
#!/bin/bash
set -eo pipefail

# if command starts with an option, prepend mysqld
if [ "${1:0:1}" = '-' ]; then
	set -- mysqld "$@"
fi

# skip setup if they want an option that stops mysqld
wantHelp=
for arg; do
	case "$arg" in
		-'?'|--help|--print-defaults|-V|--version)
			wantHelp=1
			break
			;;
	esac
done

_datadir() {
	"$@" --verbose --help --log-bin-index=`mktemp -u` 2>/dev/null | awk '$1 == "datadir" { print $2; exit }'
}

# allow the container to be started with `--user`
if [ "$1" = 'mysqld' -a -z "$wantHelp" -a "$(id -u)" = '0' ]; then
	DATADIR="$(_datadir "$@")"
	mkdir -p "$DATADIR"
	chown -R mysql:mysql "$DATADIR"
	exec gosu mysql "$BASH_SOURCE" "$@"
fi

if [ "$1" = 'mysqld' -a -z "$wantHelp" ]; then
	# Get config
	DATADIR="$(_datadir "$@")"

	if [ ! -d "$DATADIR/mysql" ]; then
		if [ -z "$MYSQL_ROOT_PASSWORD" -a -z "$MYSQL_ALLOW_EMPTY_PASSWORD" -a -z "$MYSQL_RANDOM_ROOT_PASSWORD" ]; then
			echo >&2 'error: database is uninitialized and password option is not specified '
			echo >&2 '  You need to specify one of MYSQL_ROOT_PASSWORD, MYSQL_ALLOW_EMPTY_PASSWORD and MYSQL_RANDOM_ROOT_PASSWORD'
			exit 1
		fi

		mkdir -p "$DATADIR"

		echo 'Initializing database'
		mysql_install_db --datadir="$DATADIR" --rpm
		echo 'Database initialized'

		"$@" --skip-networking &
		pid="$!"

		mysql=( mysql --protocol=socket -uroot )

		for i in {30..0}; do
			if echo 'SELECT 1' | "${mysql[@]}" &> /dev/null; then
				break
			fi
			echo 'MySQL init process in progress...'
			sleep 1
		done
		if [ "$i" = 0 ]; then
			echo >&2 'MySQL init process failed.'
			exit 1
		fi

		if [ -z "$MYSQL_INITDB_SKIP_TZINFO" ]; then
			# sed is for https://bugs.mysql.com/bug.php?id=20545
			mysql_tzinfo_to_sql /usr/share/zoneinfo | sed 's/Local time zone must be set--see zic manual page/FCTY/' | "${mysql[@]}" mysql
		fi

		if [ ! -z "$MYSQL_RANDOM_ROOT_PASSWORD" ]; then
			MYSQL_ROOT_PASSWORD="$(pwgen -1 32)"
			echo "GENERATED ROOT PASSWORD: $MYSQL_ROOT_PASSWORD"
		fi
		"${mysql[@]}" <<-EOSQL
			-- What's done in this file shouldn't be replicated
			--  or products like mysql-fabric won't work
			SET @@SESSION.SQL_LOG_BIN=0;

			DELETE FROM mysql.user ;
			CREATE USER 'root'@'%' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}' ;
			GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION ;
			DROP DATABASE IF EXISTS test ;
			FLUSH PRIVILEGES ;
		EOSQL

		if [ ! -z "$MYSQL_ROOT_PASSWORD" ]; then
			mysql+=( -p"${MYSQL_ROOT_PASSWORD}" )
		fi

		if [ "$MYSQL_DATABASE" ]; then
			echo "CREATE DATABASE IF NOT EXISTS \`$MYSQL_DATABASE\` ;" | "${mysql[@]}"
			mysql+=( "$MYSQL_DATABASE" )
		fi

		if [ "$MYSQL_USER" -a "$MYSQL_PASSWORD" ]; then
			echo "CREATE USER '$MYSQL_USER'@'%' IDENTIFIED BY '$MYSQL_PASSWORD' ;" | "${mysql[@]}"

			if [ "$MYSQL_DATABASE" ]; then
				echo "GRANT ALL ON \`$MYSQL_DATABASE\`.* TO '$MYSQL_USER'@'%' ;" | "${mysql[@]}"
			fi

			echo 'FLUSH PRIVILEGES ;' | "${mysql[@]}"
		fi

               	if [ "$MYSQL_REPLICATION_USER" -a "$MYSQL_REPLICATION_PASSWORD" ]; then
                  echo "CREATE USER '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;" | "${mysql[@]}"
	          echo "GRANT REPLICATION SLAVE ON *.* TO '$MYSQL_REPLICATION_USER'@'%' IDENTIFIED BY '$MYSQL_REPLICATION_PASSWORD' ;" | "${mysql[@]}"
                  echo 'FLUSH PRIVILEGES ;' | "${mysql[@]}"
                fi


		echo
		for f in /docker-entrypoint-initdb.d/*; do
			case "$f" in
				*.sh)     echo "$0: running $f"; . "$f" ;;
				*.sql)    echo "$0: running $f"; "${mysql[@]}" < "$f"; echo ;;
				*.sql.gz) echo "$0: running $f"; gunzip -c "$f" | "${mysql[@]}"; echo ;;
				*)        echo "$0: ignoring $f" ;;
			esac
			echo
		done

		if ! kill -s TERM "$pid" || ! wait "$pid"; then
			echo >&2 'MySQL init process failed.'
			exit 1
		fi

		echo
		echo 'MySQL init process done. Ready for start up.'
		echo
	fi
fi

exec "$@"
[vagrant@dockerlocalg ~]$




[vagrant@dockerlocalg ~]$ cat Dockerfile 
FROM mariadb:10.1.14
COPY docker-entrypoint.sh /usr/local/bin/
RUN ln -sf usr/local/bin/docker-entrypoint.sh /docker-entrypoint.sh # backwards compat
RUN chmod 775 /usr/local/bin/docker-entrypoint.sh
ENTRYPOINT ["docker-entrypoint.sh"]
EXPOSE 3306
CMD ["mysqld"]

vagrant@dockerlocalg ~]$docker build . -t ohyoungjooung2/mariadb:10.1.14-master

#This node has mariadb:10.1.14 and statefulset will reside on this node(dockerlocalg). Later, we must push this iimage.


#From master


[vagrant@kubemaster mariadb]$ kb apply -k .
secret/mariadb-pass-hmt2hb8m6g unchanged
statefulset.apps/mariadb created
[vagrant@kubemaster mariadb]$ kb get po
NAME                         READY   STATUS    RESTARTS   AGE
mariadb-0                    1/1     Running   0          2s
mariadb-slave-0              1/1     Running   1          32h
wordpress-77bd488d8b-2dtgb   1/1     Running   1          33h
[vagrant@kubemaster mariadb]$ kb exec -it mariadb-0 bash
root@mariadb-0:/# ls
bin  boot  core  dev  docker-entrypoint-initdb.d  docker-entrypoint.sh	etc  home  lib	lib64  media  mnt  opt	proc  root  run  sbin  srv  sys  tmp  usr  var
root@mariadb-0:/# mysql -p
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 3
Server version: 10.1.14-MariaDB-1~jessie mariadb.org binary distribution

Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> show masters;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near 'masters' at line 1
MariaDB [(none)]> show master;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '' at line 1
MariaDB [(none)]> show master status;
+--------------------+----------+--------------+------------------+
| File               | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+--------------------+----------+--------------+------------------+
| master1-bin.000005 |      329 |              |                  |
+--------------------+----------+--------------+------------------+
1 row in set (0.00 sec)

MariaDB [(none)]> 












